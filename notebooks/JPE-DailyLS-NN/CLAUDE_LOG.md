# CLAUDE_LOG - JPE-DailyLS-NN

## 2026-02-01: 初版NNモデル作成

### 作成したファイル
- `01_nn_model.ipynb`: 初版のNNモデル
- `01_nn_model.html`: 実行結果のHTML出力
- `models/rank_prediction_mlp.pt`: 学習済みモデル

### 概要
日本株式（大型・中型株）を対象に、Open→Closeのリターンランクを予測するMLPモデルを構築。

### データ期間
- 訓練: 2016-03-30 - 2020-12-30 (1161日)
- 検証: 2021-01-04 - 2021-12-30 (245日)
- テスト: 2022-01-04 - 2025-12-29 (977日)

### ユニバース
- TOPIX Large70, TOPIX Mid400, TOPIX Core30
- 銘柄数: 約616銘柄

### モデル
- アーキテクチャ: MLP (入力33 → 256 → 128 → 64 → 1)
- Dropout: 0.3
- 最適化: Adam (lr=0.001, weight_decay=1e-5)
- Early Stopping: patience=15

### 特徴量 (33次元)
1. ランク特徴量 (16): ret_1d/5d/10d/20d, vol_5d/10d/20d, vol_ratio, price_position, ma_dev5/10/20/60, rsi_14, prev_o2c, overnight
2. 業種ダミー (17): 17業種分類

### 結果（初版）

#### ⚠️ 問題点: データリークの疑い
ICが0.9771、勝率100%と異常な結果になっている。

**原因の考察:**
- `ret_1d` = 前日終値→当日終値の変化率を使用
- これを予測日の朝（Open時点）に使うと、当日終値情報がリークしている
- 同様に `vol_5d/10d/20d` 等も当日終値を含む

#### 現状の結果（参考値、リークあり）
| 指標 | Long-Short | TOPIX O2C |
|------|------------|-----------|
| 年率リターン | 異常値 | 3.1% |
| シャープレシオ | 異常値 | 0.23 |
| 勝率 | 100% | 51.0% |
| 平均IC | 0.977 | - |
| ICIR | 27.8 | - |

---

## 2026-02-01: 修正版NNモデル作成（リーク修正）

### 作成したファイル
- `02_nn_model_fixed.ipynb`: リーク修正版のNNモデル
- `02_nn_model_fixed.html`: 実行結果のHTML出力
- `models/rank_prediction_mlp_v2.pt`: 学習済みモデル

### 修正内容
全ての特徴量を「予測時点（当日Open）より前に取得可能な情報のみ」に修正。

**修正前（リークあり）**:
- `ret_1d` = 当日終値を使用 ❌

**修正後（リークなし）**:
- `ret_1d` = 前日終値のpct_change(1) = T-2→T-1の変化率 ✓
- 全てのrolling計算に`.shift(1)`を追加

### 結果（修正版）

| 指標 | Long-Short | Long Only | Short Only | TOPIX O2C |
|------|------------|-----------|------------|-----------|
| 累計リターン | 2.35% | 16.26% | 11.17% | 12.50% |
| 年率リターン | 0.60% | 3.96% | 2.77% | 3.09% |
| 年率ボラ | 10.54% | 12.60% | 12.63% | 13.69% |
| シャープレシオ | 0.057 | 0.31 | 0.22 | 0.23 |
| 最大DD | -29.4% | -17.6% | -23.2% | -22.1% |
| 勝率 | 49.0% | 51.3% | 51.8% | 51.0% |

### 予測精度
| 指標 | 値 |
|------|-----|
| 平均IC | 0.0041 |
| IC標準偏差 | 0.0916 |
| ICIR | 0.045 |
| ICプラス率 | 52.2% |

### 評価
- ICが0.004と非常に低く、現状のモデル・特徴量では予測能力がほぼない
- Long-Shortでほぼ収益が出ておらず、TOPIXをアンダーパフォーム
- シャープレシオ0.057は投資適格水準に達していない

### 次のステップ（改善案）
1. **特徴量の追加**
   - ファンダメンタル指標（PER, PBR, ROE等）を`fins_summary`から取得
   - 信用残データ（`markets_margin_interest`）
   - 空売り比率データ（`markets_short_ratio`）
   - 市場全体のセンチメント指標

2. **モデル改善**
   - より深いネットワーク or Attention機構
   - LightGBM等の勾配ブースティングとのアンサンブル
   - 特徴量選択（重要度低い特徴量の削除）

3. **ターゲットの再検討**
   - ランク予測→分位予測（上位/下位の2値分類）
   - Open→Close以外のターゲット（Close→翌Open等）

4. **リサンプリング**
   - 学習データの期間を延長
   - Walk-forward検証の期間を調整

---

## 2026-02-01: Attention NN + ポジションデータ

### 作成したファイル
- `03_nn_attention_with_positions.ipynb`: Attention + 信用残・空売りデータ
- `03_nn_attention_with_positions.html`: 実行結果
- `models/attention_rank_predictor_v1.pt`: 学習済みモデル

### 改善内容
1. **モデルアーキテクチャ**: Self-Attention機構を追加
2. **特徴量追加**:
   - 信用残データ (`markets_margin_interest`): margin_ratio, margin_balance, その変化率
   - 空売り比率 (`markets_short_ratio`): 業種別の空売り比率とその変化率
3. **特徴量数**: 33 → 44

### 結果

| 指標 | Long-Short | Long Only | Short Only | TOPIX O2C |
|------|------------|-----------|------------|-----------|
| 累計リターン | **426.9%** | 99.0% | -63.1% | 12.5% |
| 年率リターン | **53.5%** | 19.4% | -22.7% | 3.1% |
| 年率ボラ | 9.3% | 12.0% | 12.8% | 13.7% |
| シャープレシオ | **5.76** | 1.61 | -1.77 | 0.23 |
| 最大DD | -3.6% | -10.0% | -63.6% | -22.1% |
| 勝率 | **61.2%** | 52.9% | 46.1% | 51.0% |

### 予測精度
| 指標 | v2 (MLP) | v3 (Attention) |
|------|----------|----------------|
| 平均IC | 0.0041 | **0.0118** |
| ICIR | 0.045 | **0.139** |
| ICプラス率 | 52.2% | **55.0%** |

### 評価
- ICが0.0041→0.0118と約3倍に改善
- シャープレシオ5.76は非常に高い（要検証）
- 勝率61%は良好な水準

### ⚠️ 注意点
シャープレシオ5.76は現実的な運用では達成困難な水準。以下を検証する必要がある：
1. 信用残データのLook-ahead biasがないか（週次データの前方埋めは適切か）
2. 空売り比率データの取得タイミング
3. 執行可能性（Open価格での約定が可能か）
4. 取引コスト（手数料・マーケットインパクト）の影響
